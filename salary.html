<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Salary Management</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    .sidebar { min-height: 100vh; background-color: #343a40; }
    .sidebar .nav-link { color: rgba(255, 255, 255, 0.75); }
    .sidebar .nav-link:hover, .sidebar .nav-link.active {
      color: white; background-color: rgba(255, 255, 255, 0.1);
    }
    .main-content { padding: 20px; }
    .worker-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
    }
  </style>
</head>
<body>
<div class="container-fluid">
  <div class="row">
    <!-- Sidebar -->
    <div class="col-md-2 sidebar p-0">
      <div class="p-3 text-white">
        <h4>Admin Dashboard</h4>
        <hr class="bg-light">
      </div>
      <ul class="nav flex-column">
        <li class="nav-item"><a class="nav-link" href="admin.html"><i class="fas fa-arrow-left me-2"></i>Back to Dashboard</a></li>
      </ul>
    </div>

    <!-- Main Content -->
    <div class="col-md-10 main-content">
      <h3 class="mb-4"><i class="fas fa-wallet me-2"></i>Salary Payment Setup</h3>
      <div class="table-responsive">
        <table class="table table-striped table-hover">
          <thead class="table-dark">
            <tr>
              <th>Worker Name</th>
              <th>Salary Type</th>
              <th>Monthly Salary Amount (₹)</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="salaryTableBody">
            <!-- Workers loaded here -->
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Edit Salary Modal -->
<div class="modal fade" id="editSalaryModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Update Salary Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="editWorkerId">
        <div class="mb-3">
          <label class="form-label">Salary Type</label>
          <select id="editSalaryType" class="form-select">
            <option value="daily">Daily</option>
            <option value="monthly">Monthly</option>
          </select>
        </div>
        <div class="mb-3">
          <label class="form-label">Monthly Salary Amount (₹)</label>
          <input type="number" class="form-control" id="editMonthlyAmount" placeholder="Enter amount">
          <small class="text-muted">For daily salary workers, keep this empty or zero.</small>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-primary" onclick="saveSalaryDetails()">Save Changes</button>
      </div>
    </div>
  </div>
</div>

<!-- Scripts -->
<script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="firebase-config.js"></script>
<script>
const db = firebase.firestore();

// Load workers: fetch unique workerName + UID from workRecords, then salary from 'salaries'
async function loadWorkers() {
  try {
    const salaryTableBody = document.getElementById('salaryTableBody');
    salaryTableBody.innerHTML = `
      <tr><td colspan="4" class="text-center">Loading...</td></tr>
    `;

    const workSnapshot = await db.collection('workRecords').get();
    const uniqueWorkers = {}; // uid -> workerName

    workSnapshot.forEach(doc => {
      const data = doc.data();
      if (data.uid && data.workerName && !uniqueWorkers[data.uid]) {
        uniqueWorkers[data.uid] = data.workerName;
      }
    });

    salaryTableBody.innerHTML = '';

    if (Object.keys(uniqueWorkers).length === 0) {
      salaryTableBody.innerHTML = `
        <tr><td colspan="4" class="text-center text-muted">No workers found</td></tr>
      `;
      return;
    }

    for (const uid in uniqueWorkers) {
      const workerName = uniqueWorkers[uid];
      let salaryType = 'Not set';
      let monthlyAmount = 0;

      try {
        const salaryDoc = await db.collection('salaries').doc(uid).get();
        if (salaryDoc.exists) {
          const salaryData = salaryDoc.data();
          salaryType = salaryData.salaryType || 'Not set';
          monthlyAmount = salaryData.monthlyAmount || 0;
        }
      } catch (e) {
        console.error(`Failed to get salary for ${workerName}:`, e);
      }

      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${workerName}</td>
        <td>${salaryType}</td>
        <td>₹${monthlyAmount}</td>
        <td>
          <button class="btn btn-sm btn-primary" 
            onclick="openEditModal('${uid}', '${salaryType}', '${monthlyAmount}')">
            <i class="fas fa-edit"></i> Edit
          </button>
        </td>
      `;
      salaryTableBody.appendChild(row);
    }

  } catch (e) {
    console.error(e);
    alert('Failed to load workers');
  }
}

// Open modal
function openEditModal(workerId, salaryType, monthlyAmount) {
  document.getElementById('editWorkerId').value = workerId;
  document.getElementById('editSalaryType').value = salaryType;
  document.getElementById('editMonthlyAmount').value = monthlyAmount;
  new bootstrap.Modal(document.getElementById('editSalaryModal')).show();
}

// Save salary to 'salaries' collection
async function saveSalaryDetails() {
  const workerId = document.getElementById('editWorkerId').value;
  const salaryType = document.getElementById('editSalaryType').value;
  const monthlyAmount = parseFloat(document.getElementById('editMonthlyAmount').value) || 0;

  try {
    await db.collection('salaries').doc(workerId).set({
      salaryType,
      monthlyAmount
    });
    alert('Salary details updated!');
    bootstrap.Modal.getInstance(document.getElementById('editSalaryModal')).hide();
    loadWorkers();
  } catch (e) {
    console.error(e);
    alert('Failed to update salary');
  }
}

// Init
document.addEventListener('DOMContentLoaded', loadWorkers);
</script>
</body>
</html>
